<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>3D Print Snap</title>
<style>
body,html{
  margin:0;
  padding:0;
  height:100%;
  background:#000;
  color:#fff;
  font-family:sans-serif;
  display:flex;
  flex-direction:column;
}
#camera-container{
  position:relative;
  width:100%;
  height:70%; /* camera takes up 70% */
  background:#000;
}
video,canvas{
  width:100%;
  height:100%;
  object-fit:cover;
}
.profile-pic{
  position:absolute;
  top:10px;
  left:10px;
  width:40px;
  height:40px;
  border-radius:50%;
  z-index:10;
}
.save-icon{
  position:absolute;
  top:10px;
  right:10px;
  width:30px;
  height:30px;
  z-index:10;
  cursor:pointer;
}
.x-button{
  position:absolute;
  top:10px;
  left:55px;
  background:#fff;
  color:#000;
  padding:3px 8px;
  border-radius:5px;
  z-index:10;
  cursor:pointer;
}
.capture-button{
  width:70px;
  height:70px;
  border-radius:50%;
  background:#fff;
  border:none;
  margin:10px auto;
  display:block;
}
#post-options{
  padding:10px;
  background:#111;
}
label.stl-button{
  display:inline-block;
  padding:5px 10px;
  background:#444;
  border-radius:5px;
  cursor:pointer;
}
.bottom-nav{
  margin-top:auto;
  width:100%;
  display:flex;
  justify-content:space-around;
  background:rgba(0,0,0,0.3);
  padding:10px 0;
}
.hidden{display:none;}
</style>
</head>
<body>

<div id="camera-container">
  <img id="profilePic" class="profile-pic hidden" src="">
  <img src="https://cdn-icons-png.flaticon.com/512/1827/1827392.png" class="save-icon" id="saveCapture">
  <div id="discardBtn" class="x-button hidden">X</div>
  <video id="camera" autoplay playsinline></video>
</div>

<button class="capture-button" id="captureBtn"></button>

<div id="post-options" class="hidden">
  <input type="text" id="caption" placeholder="Add a caption" style="width:90%"><br><br>
  <select id="printerGuess">
    <option>AI guess: Prusa MK3S+</option>
    <option>Ender 3 V2</option>
    <option>Bambu Labs X1C</option>
    <option>Anycubic Kobra</option>
    <option>Other</option>
  </select><br><br>
  <label for="stl-upload" class="stl-button">Upload STL</label>
  <input type="file" id="stl-upload" accept=".stl" style="display:none;"><span id="stlName"></span><br><br>
  <button id="postStory">Post to Story</button>
  <button id="postSpotlight">Post to Spotlight</button>
</div>

<div class="bottom-nav">
  <button onclick="location.href='index.html'">ðŸ“·</button>
  <button onclick="location.href='stories.html'">ðŸ“–</button>
  <button onclick="location.href='feed.html'">ðŸŒŸ</button>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-auth.js";
import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-storage.js";
import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyA-lNZ4RQS7Xpu2_vzBPCBaBsi_0TlL8dk",
  authDomain: "appp-5f90c.firebaseapp.com",
  projectId: "appp-5f90c",
  storageBucket: "appp-5f90c.appspot.com", // fixed
  messagingSenderId: "215310083943",
  appId: "1:215310083943:web:7869ceb90a03567558b1c2",
  measurementId: "G-JJQCFT3PQ9"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const storage = getStorage(app);
const db = getFirestore(app);

// sign in with Google
const provider = new GoogleAuthProvider();
signInWithPopup(auth, provider).catch(console.error);

onAuthStateChanged(auth, user=>{
  if(user){
    document.getElementById('profilePic').src = user.photoURL;
    document.getElementById('profilePic').classList.remove('hidden');
  }
});

// Camera
const video = document.getElementById('camera');
let currentCanvas;
navigator.mediaDevices.getUserMedia({ video: true, audio:false })
  .then(stream => { video.srcObject = stream; });

const captureBtn = document.getElementById('captureBtn');
const postOptions = document.getElementById('post-options');
const discardBtn = document.getElementById('discardBtn');

captureBtn.addEventListener('click',()=>{
  if(currentCanvas){ currentCanvas.remove(); }
  const canvas = document.createElement('canvas');
  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;
  canvas.getContext('2d').drawImage(video,0,0);
  video.classList.add('hidden');
  document.getElementById('camera-container').appendChild(canvas);
  currentCanvas = canvas;
  postOptions.classList.remove('hidden');
  discardBtn.classList.remove('hidden');
});

discardBtn.addEventListener('click',()=>{
  if(currentCanvas){ currentCanvas.remove(); currentCanvas=null;}
  video.classList.remove('hidden');
  postOptions.classList.add('hidden');
  discardBtn.classList.add('hidden');
});

// Save captured frame locally
document.getElementById('saveCapture').addEventListener('click',()=>{
  if(!currentCanvas) return;
  const a = document.createElement('a');
  a.href = currentCanvas.toDataURL('image/png');
  a.download = 'capture.png';
  a.click();
});

// STL upload
let stlFile=null;
document.getElementById('stl-upload').addEventListener('change', e=>{
  stlFile = e.target.files[0];
  if(stlFile){
    document.getElementById('stlName').innerText = stlFile.name;
  }
});

async function uploadPost(type){
  const user = auth.currentUser;
  if(!user || !currentCanvas) return;
  const blob = await new Promise(resolve=>currentCanvas.toBlob(resolve,'image/png'));
  const imgRef = ref(storage, `${type}/${user.uid}-${Date.now()}.png`);
  await uploadBytes(imgRef, blob);
  const imageURL = await getDownloadURL(imgRef);
  let stlURL='';
  if(stlFile){
    const stlRef = ref(storage, `${type}/stl/${user.uid}-${Date.now()}.stl`);
    await uploadBytes(stlRef, stlFile);
    stlURL = await getDownloadURL(stlRef);
  }
  await addDoc(collection(db,type),{
    userId:user.uid,
    userName:user.displayName,
    userPhoto:user.photoURL,
    caption:document.getElementById('caption').value,
    printer:document.getElementById('printerGuess').value,
    imageURL:imageURL,
    stlURL:stlURL,
    timestamp:serverTimestamp()
  });
  alert('Posted to '+type);
  postOptions.classList.add('hidden');
  if(currentCanvas){ currentCanvas.remove(); currentCanvas=null;}
  video.classList.remove('hidden');
  discardBtn.classList.add('hidden');
}

document.getElementById('postStory').addEventListener('click',()=>uploadPost('stories'));
document.getElementById('postSpotlight').addEventListener('click',()=>uploadPost('spotlight'));
</script>
</body>
</html>
