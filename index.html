// App.js
import React, { useState, useRef } from 'react';
import { View, Text, Button, Image, TouchableOpacity, TextInput, StyleSheet } from 'react-native';
import { NavigationContainer } from '@react-navigation/native';
import { createBottomTabNavigator } from '@react-navigation/bottom-tabs';
import { Ionicons } from '@expo/vector-icons';
import { Camera } from 'expo-camera';
import * as MediaLibrary from 'expo-media-library';

const Tab = createBottomTabNavigator();

// ----- Screen 1: Your Posts -----
function YourPostsScreen() {
  return (
    <View style={styles.center}>
      <Text>Your Posts will appear here.</Text>
    </View>
  );
}

// ----- Screen 2: Camera -----
function CameraScreen() {
  const [hasPermission, setHasPermission] = useState(null);
  const [capturedPhoto, setCapturedPhoto] = useState(null);
  const [textOverlay, setTextOverlay] = useState('');
  const cameraRef = useRef(null);

  React.useEffect(() => {
    (async () => {
      const { status } = await Camera.requestCameraPermissionsAsync();
      const mediaStatus = await MediaLibrary.requestPermissionsAsync();
      setHasPermission(status === 'granted' && mediaStatus.status === 'granted');
    })();
  }, []);

  const takePicture = async () => {
    if (cameraRef.current) {
      const photo = await cameraRef.current.takePictureAsync();
      setCapturedPhoto(photo.uri);
    }
  };

  const saveToDevice = async () => {
    if (capturedPhoto) {
      await MediaLibrary.createAssetAsync(capturedPhoto);
      alert('Saved to device!');
      setCapturedPhoto(null);
      setTextOverlay('');
    }
  };

  if (hasPermission === null) {
    return <View style={styles.center}><Text>Requesting camera permissions...</Text></View>;
  }
  if (hasPermission === false) {
    return <View style={styles.center}><Text>No access to camera</Text></View>;
  }

  return (
    <View style={{ flex: 1 }}>
      {!capturedPhoto ? (
        <Camera style={{ flex: 1 }} ref={cameraRef}>
          <View style={styles.cameraButtonContainer}>
            <TouchableOpacity style={styles.cameraButton} onPress={takePicture} />
          </View>
        </Camera>
      ) : (
        <View style={{ flex: 1 }}>
          <Image source={{ uri: capturedPhoto }} style={{ flex: 1 }} />
          <TextInput
            placeholder="Add text..."
            value={textOverlay}
            onChangeText={setTextOverlay}
            style={styles.textInput}
          />
          <View style={styles.actionButtons}>
            <Button title="Post" onPress={() => alert('Posted!')} />
            <Button title="Delete" color="red" onPress={() => { setCapturedPhoto(null); setTextOverlay(''); }} />
            <Button title="Save" onPress={saveToDevice} />
          </View>
        </View>
      )}
    </View>
  );
}

// ----- Screen 3: Posts Feed -----
function PostsScreen() {
  return (
    <View style={styles.center}>
      <Text>Posts feed will appear here.</Text>
    </View>
  );
}

// ----- App Navigator -----
export default function App() {
  return (
    <NavigationContainer>
      <Tab.Navigator
        screenOptions={({ route }) => ({
          tabBarIcon: ({ color, size }) => {
            let iconName;
            if (route.name === 'Your Posts') iconName = 'person-outline';
            else if (route.name === 'Camera') iconName = 'camera-outline';
            else if (route.name === 'Feed') iconName = 'film-outline';
            return <Ionicons name={iconName} size={size} color={color} />;
          },
          tabBarActiveTintColor: 'tomato',
          tabBarInactiveTintColor: 'gray',
        })}
      >
        <Tab.Screen name="Your Posts" component={YourPostsScreen} />
        <Tab.Screen name="Camera" component={CameraScreen} />
        <Tab.Screen name="Feed" component={PostsScreen} />
      </Tab.Navigator>
    </NavigationContainer>
  );
}

// ----- Styles -----
const styles = StyleSheet.create({
  center: { flex: 1, justifyContent: 'center', alignItems: 'center' },
  cameraButtonContainer: { flex: 1, justifyContent: 'flex-end', alignItems: 'center', marginBottom: 20 },
  cameraButton: { width: 70, height: 70, backgroundColor: 'white', borderRadius: 35 },
  textInput: {
    position: 'absolute', top: 50, left: 20, right: 20, backgroundColor: 'rgba(0,0,0,0.4)',
    color: 'white', padding: 10, borderRadius: 10
  },
  actionButtons: { flexDirection: 'row', justifyContent: 'space-around', padding: 10 }
});
