<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SnapClone â€” Firebase GitHub Pages Demo</title>
  <style>
    :root{
      --snap-yellow: #FFFC00;
      --snap-dark: #111827;
      --muted: #6b7280;
      --card-bg: #ffffff;
      --gap: 12px;
      font-family: Inter, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial;
    }
    html,body{height:100%;margin:0;background:#f3f4f6;color:var(--snap-dark);}
    .app{min-height:100%;display:flex;flex-direction:column;max-width:900px;margin:0 auto;background:transparent;}
    header{display:flex;align-items:center;justify-content:space-between;padding:14px 16px;background:#ffffff;border-bottom:1px solid #e6e7e8;position:sticky;top:0;z-index:20}
    header h1{font-size:18px;margin:0}
    header .user{display:flex;align-items:center;gap:10px}
    header img.avatar{height:36px;width:36px;border-radius:999px;object-fit:cover}
    main{flex:1;padding:16px}
    .card{background:var(--card-bg);border-radius:14px;padding:12px;box-shadow:0 6px 18px rgba(15,23,42,0.06);margin-bottom:var(--gap)}
    .nav{position:sticky;bottom:0;background:#fff;border-top:1px solid #e6e7e8;padding:10px 16px;display:flex;gap:8px;align-items:center;justify-content:space-between}
    .tab-btn{flex:1;padding:8px 10px;border-radius:10px;background:transparent;border:0;display:flex;flex-direction:column;align-items:center;gap:6px;color:var(--muted);cursor:pointer}
    .tab-btn.active{color:var(--snap-yellow);font-weight:600}
    /* camera area */
    .camera-wrap{position:relative;border-radius:12px;overflow:hidden;background:#000;height:60vh;display:flex;align-items:center;justify-content:center}
    video{width:100%;height:100%;object-fit:cover;display:block}
    .camera-controls{display:flex;gap:8px;margin-top:12px;align-items:center}
    .btn{padding:9px 14px;border-radius:10px;border:0;cursor:pointer;font-weight:600}
    .btn-primary{background:var(--snap-yellow)}
    .btn-ghost{background:#fff;border:1px solid #eaeaea}
    .btn-danger{background:#ffecec;color:#b91c1c}
    .input{flex:1;padding:10px;border-radius:10px;border:1px solid #e6e7e8}
    .grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
    .post-img{width:100%;height:170px;object-fit:cover;border-radius:8px}
    .meta{display:flex;align-items:center;gap:8px;margin-top:8px}
    .small{font-size:12px;color:var(--muted)}
    .center{display:flex;align-items:center;justify-content:center}
    .overlay-preview{position:absolute;left:0;right:0;bottom:32px;padding:8px;text-align:center;font-weight:700;text-shadow:0 2px 6px rgba(0,0,0,0.6);color:white}
    /* responsive */
    @media (max-width:520px){ .camera-wrap{height:52vh} .post-img{height:140px} header h1{font-size:16px} }
  </style>
</head>
<body>
  <div class="app" id="app">
    <header>
      <h1>SnapClone</h1>
      <div class="user" id="userBox">
        <!-- Filled by JS -->
        <button class="btn btn-primary" id="signInBtn">Sign in with Google</button>
      </div>
    </header>

    <main>
      <!-- PROFILE -->
      <section id="profileView" style="display:none">
        <div class="card">
          <div style="display:flex;align-items:center;gap:12px">
            <img id="profileAvatar" src="" class="avatar" style="display:none">
            <div>
              <div id="profileName" style="font-weight:700"></div>
              <div class="small" id="profileEmail"></div>
            </div>
          </div>
          <div style="margin-top:12px" class="small">Your snaps (only snaps you posted are shown here).</div>
        </div>

        <div id="profileSnaps" class="grid"></div>
      </section>

      <!-- CAMERA -->
      <section id="cameraView" style="display:none">
        <div class="card">
          <div class="camera-wrap" id="cameraWrap">
            <video id="video" autoplay playsinline muted></video>
            <div class="overlay-preview" id="overlayPreview" style="display:none"></div>
            <canvas id="canvas" style="display:none"></canvas>
          </div>

          <div style="display:flex;gap:8px;margin-top:10px">
            <input id="overlayInput" class="input" placeholder="Add text overlay (appears near bottom)" />
            <button id="flipBtn" class="btn btn-ghost">Flip</button>
          </div>

          <div class="camera-controls">
            <button id="captureBtn" class="btn btn-primary">Capture</button>
            <button id="clearBtn" class="btn btn-ghost" disabled>Clear</button>
            <div style="flex:1"></div>
            <div class="small" id="cameraStatus">Camera off</div>
          </div>

          <div id="previewActions" style="display:none;margin-top:12px" class="camera-controls">
            <button id="postBtn" class="btn" style="background:#14b8a6;color:white">Post</button>
            <button id="saveBtn" class="btn btn-ghost">Save to device</button>
            <button id="deleteBtn" class="btn btn-danger">Delete</button>
            <div style="flex:1"></div>
            <div class="small" id="uploadStatus"></div>
          </div>
        </div>
      </section>

      <!-- FEED -->
      <section id="feedView" style="display:none">
        <div class="card">
          <div style="display:flex;align-items:center;justify-content:space-between">
            <div style="font-weight:700">Feed</div>
            <div class="small">Public snaps</div>
          </div>
        </div>

        <div id="feedGrid" class="grid"></div>
      </section>
    </main>

    <nav class="nav">
      <button id="profileTab" class="tab-btn">
        <div>ðŸ‘¤</div><div>Profile</div>
      </button>
      <button id="cameraTab" class="tab-btn active">
        <div style="font-size:18px">ðŸ“¸</div><div>Camera</div>
      </button>
      <button id="feedTab" class="tab-btn">
        <div>ðŸ“°</div><div>Feed</div>
      </button>
    </nav>
  </div>

  <!-- Firebase (modular SDK via ESM). Using version 9.x CDN imports -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-analytics.js";
    import {
      getAuth,
      signInWithPopup,
      GoogleAuthProvider,
      signOut,
      onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";
    import {
      getFirestore,
      collection,
      addDoc,
      query,
      orderBy,
      onSnapshot,
      serverTimestamp
    } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";
    import {
      getStorage,
      ref as storageRef,
      uploadString,
      getDownloadURL
    } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-storage.js";

    // ================ Firebase config (bundled as requested) =================
    const firebaseConfig = {
      apiKey: "AIzaSyA-lNZ4RQS7Xpu2_vzBPCBaBsi_0TlL8dk",
      authDomain: "appp-5f90c.firebaseapp.com",
      projectId: "appp-5f90c",
      storageBucket: "appp-5f90c.appspot.com",
      messagingSenderId: "215310083943",
      appId: "1:215310083943:web:7869ceb90a03567558b1c2",
      measurementId: "G-JJQCFT3PQ9"
    };

    // Initialize
    const app = initializeApp(firebaseConfig);
    try { getAnalytics(app); } catch (e) { /* analytics not critical */ }
    const auth = getAuth(app);
    const provider = new GoogleAuthProvider();
    const db = getFirestore(app);
    const storage = getStorage(app);

    // ================ UI references ================
    const signInBtn = document.getElementById('signInBtn');
    const userBox = document.getElementById('userBox');
    const profileAvatar = document.getElementById('profileAvatar');
    const profileName = document.getElementById('profileName');
    const profileEmail = document.getElementById('profileEmail');
    const profileSnaps = document.getElementById('profileSnaps');

    const profileTab = document.getElementById('profileTab');
    const cameraTab = document.getElementById('cameraTab');
    const feedTab = document.getElementById('feedTab');
    const profileView = document.getElementById('profileView');
    const cameraView = document.getElementById('cameraView');
    const feedView = document.getElementById('feedView');

    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const captureBtn = document.getElementById('captureBtn');
    const clearBtn = document.getElementById('clearBtn');
    const overlayInput = document.getElementById('overlayInput');
    const overlayPreview = document.getElementById('overlayPreview');
    const previewActions = document.getElementById('previewActions');
    const postBtn = document.getElementById('postBtn');
    const saveBtn = document.getElementById('saveBtn');
    const deleteBtn = document.getElementById('deleteBtn');
    const flipBtn = document.getElementById('flipBtn');
    const cameraStatus = document.getElementById('cameraStatus');
    const uploadStatus = document.getElementById('uploadStatus');

    const feedGrid = document.getElementById('feedGrid');

    // ================ App state ================
    let currentUser = null;
    let mediaStream = null;
    let capturedDataUrl = null;
    let facingMode = 'user'; // 'user' or 'environment'

    // ================ NAV logic ================
    function showTab(tab){
      // update active classes
      [profileTab,cameraTab,feedTab].forEach(btn=>btn.classList.remove('active'));
      if(tab==='profile'){ profileTab.classList.add('active'); profileView.style.display='block'; cameraView.style.display='none'; feedView.style.display='none';}
      if(tab==='camera'){ cameraTab.classList.add('active'); profileView.style.display='none'; cameraView.style.display='block'; feedView.style.display='none';}
      if(tab==='feed'){ feedTab.classList.add('active'); profileView.style.display='none'; cameraView.style.display='none'; feedView.style.display='block';}
      if(tab==='camera') startCamera();
      else stopCamera();
      if(tab === 'profile') renderProfileSnaps();
    }
    profileTab.addEventListener('click', ()=>showTab('profile'));
    cameraTab.addEventListener('click', ()=>showTab('camera'));
    feedTab.addEventListener('click', ()=>showTab('feed'));

    // show camera by default
    showTab('camera');

    // ================ AUTH ================
    signInBtn.addEventListener('click', async () => {
      try {
        await signInWithPopup(auth, provider);
      } catch (err) {
        alert('Sign-in failed: ' + err.message);
        console.error(err);
      }
    });

    async function signOutUser(){
      try {
        await signOut(auth);
      } catch (err) {
        console.error('Sign out failed', err);
      }
    }

    onAuthStateChanged(auth, (user) => {
      currentUser = user;
      updateUserUI();
    });

    function updateUserUI(){
      userBox.innerHTML = '';
      if(currentUser){
        const img = document.createElement('img');
        img.src = currentUser.photoURL || '';
        img.className = 'avatar';
        img.alt = 'avatar';
        userBox.appendChild(img);

        const name = document.createElement('div');
        name.textContent = currentUser.displayName || 'User';
        name.style.fontSize = '14px';
        name.style.color = 'var(--muted)';
        userBox.appendChild(name);

        const signOutBtn = document.createElement('button');
        signOutBtn.textContent = 'Sign out';
        signOutBtn.className = 'btn btn-ghost';
        signOutBtn.style.marginLeft = '8px';
        signOutBtn.onclick = signOutUser;
        userBox.appendChild(signOutBtn);

        // Profile area
        profileAvatar.src = currentUser.photoURL || '';
        profileAvatar.style.display = currentUser.photoURL ? 'block' : 'none';
        profileName.textContent = currentUser.displayName || '';
        profileEmail.textContent = currentUser.email || '';
      } else {
        // show sign-in button
        const btn = document.createElement('button');
        btn.textContent = 'Sign in with Google';
        btn.id = 'signInBtn';
        btn.className = 'btn btn-primary';
        btn.onclick = async () => {
          try { await signInWithPopup(auth, provider); } catch(e){ alert('Sign-in failed: '+e.message); }
        };
        userBox.appendChild(btn);

        profileAvatar.style.display = 'none';
        profileName.textContent = '';
        profileEmail.textContent = '';
      }
    }

    // ================ CAMERA ================
    async function startCamera(){
      try {
        stopCamera();
        cameraStatus.textContent = 'Starting camera...';
        mediaStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode }, audio: false });
        video.srcObject = mediaStream;
        cameraStatus.textContent = 'Camera active';
        captureBtn.disabled = false;
        clearBtn.disabled = true;
      } catch (err) {
        cameraStatus.textContent = 'Camera error';
        captureBtn.disabled = true;
        console.error('Camera start error', err);
        alert('Camera access failed. Make sure you allowed camera access and are on HTTPS.');
      }
    }

    function stopCamera(){
      if(mediaStream){
        mediaStream.getTracks().forEach(t => t.stop());
        mediaStream = null;
      }
      video.srcObject = null;
      cameraStatus.textContent = 'Camera off';
      captureBtn.disabled = true;
    }

    flipBtn.addEventListener('click', ()=>{
      facingMode = (facingMode === 'user') ? 'environment' : 'user';
      startCamera();
    });

    captureBtn.addEventListener('click', ()=>{
      capturePhoto();
    });

    clearBtn.addEventListener('click', ()=>{
      overlayInput.value = '';
      overlayPreview.style.display = 'none';
      clearBtn.disabled = true;
    });

    overlayInput.addEventListener('input', ()=>{
      overlayPreview.textContent = overlayInput.value;
      overlayPreview.style.display = overlayInput.value ? 'block' : 'none';
    });

    function capturePhoto(){
      if(!mediaStream) return;
      const w = video.videoWidth || 1280;
      const h = video.videoHeight || 720;
      canvas.width = w; canvas.height = h;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(video, 0, 0, w, h);

      // draw overlay text if present
      const text = overlayInput.value && overlayInput.value.trim();
      if(text){
        const fontSize = Math.max(24, Math.floor(w / 18));
        ctx.font = `${fontSize}px Inter, system-ui, -apple-system, 'Segoe UI', Roboto, Arial`;
        ctx.textAlign = 'center';
        ctx.fillStyle = 'white';
        ctx.lineWidth = Math.ceil(fontSize / 6);
        ctx.strokeStyle = 'rgba(0,0,0,0.6)';
        const x = w / 2;
        const y = h - fontSize * 1.5;
        ctx.strokeText(text, x, y);
        ctx.fillText(text, x, y);
      }

      capturedDataUrl = canvas.toDataURL('image/jpeg', 0.92);
      // show preview
      const imgPreview = document.createElement('img');
      imgPreview.src = capturedDataUrl;
      imgPreview.style.width = '100%';
      imgPreview.style.height = '100%';
      imgPreview.style.objectFit = 'contain';
      // clear the camera-wrap and show the preview image
      const cameraWrap = document.getElementById('cameraWrap');
      cameraWrap.innerHTML = '';
      cameraWrap.appendChild(imgPreview);
      previewActions.style.display = 'flex';
      clearBtn.disabled = false;
      captureBtn.disabled = true;
      stopCamera(); // stop camera while previewing
    }

    deleteBtn.addEventListener('click', ()=>{
      clearPreview();
    });

    function clearPreview(){
      capturedDataUrl = null;
      const cameraWrap = document.getElementById('cameraWrap');
      cameraWrap.innerHTML = '';
      cameraWrap.appendChild(video);
      if(overlayInput.value) overlayPreview.style.display = 'block';
      else overlayPreview.style.display = 'none';
      previewActions.style.display = 'none';
      captureBtn.disabled = false;
      clearBtn.disabled = true;
      startCamera();
      uploadStatus.textContent = '';
    }

    saveBtn.addEventListener('click', ()=>{
      if(!capturedDataUrl) return;
      const a = document.createElement('a');
      a.href = capturedDataUrl;
      a.download = 'snap_' + Date.now() + '.jpg';
      document.body.appendChild(a);
      a.click();
      a.remove();
    });

    // ================ UPLOAD & FIRESTORE ================
    postBtn.addEventListener('click', async ()=>{
      if(!capturedDataUrl) return alert('No photo to post.');
      if(!currentUser) return alert('Sign in with Google to post.');

      uploadStatus.textContent = 'Uploading...';
      postBtn.disabled = true;
      try {
        const path = `snaps/${currentUser.uid}/${Date.now()}.jpg`;
        const sRef = storageRef(storage, path);
        // upload data URL
        await uploadString(sRef, capturedDataUrl, 'data_url');
        const url = await getDownloadURL(sRef);
        // create firestore doc
        await addDoc(collection(db, 'snaps'), {
          imageURL: url,
          text: overlayInput.value || '',
          createdAt: serverTimestamp(),
          uid: currentUser.uid,
          displayName: currentUser.displayName || null,
          photoURL: currentUser.photoURL || null
        });
        uploadStatus.textContent = 'Posted!';
        // clear preview and go to feed
        clearPreview();
        showTab('feed');
      } catch (err) {
        console.error('Upload error', err);
        alert('Upload failed: ' + (err.message || err));
        uploadStatus.textContent = 'Upload failed';
      } finally {
        postBtn.disabled = false;
        setTimeout(()=>uploadStatus.textContent = '', 2000);
      }
    });

    // ================ FEED (realtime) ================
    const snapsQuery = query(collection(db, 'snaps'), orderBy('createdAt', 'desc'));
    onSnapshot(snapsQuery, (snap) =>{
      const items = [];
      snap.forEach(doc => {
        items.push({ id: doc.id, ...doc.data() });
      });
      renderFeed(items);
      // if profile open, update profile listing too
      renderProfileSnaps(items);
    }, (err) => {
      console.error('Feed snapshot error', err);
    });

    function timeFromTs(ts){
      try {
        if(!ts) return '';
        // ts may be a Firestore Timestamp with toDate()
        if(typeof ts.toDate === 'function') return ts.toDate().toLocaleString();
        // else maybe a plain string or number
        return new Date(ts).toLocaleString();
      } catch(e){ return ''; }
    }

    function renderFeed(items){
      feedGrid.innerHTML = '';
      if(items.length === 0){
        feedGrid.innerHTML = '<div class="card">No snaps yet â€” be the first!</div>';
        return;
      }
      items.forEach(item=>{
        const div = document.createElement('div');
        div.className = 'card';
        const img = document.createElement('img');
        img.className = 'post-img';
        img.src = item.imageURL || '';
        img.alt = 'snap';
        div.appendChild(img);

        const meta = document.createElement('div');
        meta.className = 'meta';
        const left = document.createElement('div');
        left.innerHTML = `<div style="font-weight:700">${item.displayName||'Unknown'}</div><div class="small">${item.text||''}</div>`;
        const right = document.createElement('div'); right.className='small'; right.textContent = timeFromTs(item.createdAt);
        meta.appendChild(left); meta.appendChild(right);
        div.appendChild(meta);

        feedGrid.appendChild(div);
      });
    }

    function renderProfileSnaps(allItems){
      // if snapshot callback provided items, use that; else we'll query by listening result
      // We'll filter allItems if given, else re-use feedGrid items by reading current feed snapshot.
      if(!allItems){
        // do nothing â€” onSnapshot handler will call this with items
        return;
      }
      const myItems = allItems.filter(i => currentUser && i.uid === currentUser.uid);
      profileSnaps.innerHTML = '';
      if(myItems.length === 0){
        profileSnaps.innerHTML = '<div class="card small">You have not posted any snaps yet.</div>';
        return;
      }
      myItems.forEach(item=>{
        const div = document.createElement('div');
        div.className = 'card';
        const img = document.createElement('img');
        img.className = 'post-img';
        img.src = item.imageURL || '';
        img.alt = 'snap';
        div.appendChild(img);

        const meta = document.createElement('div');
        meta.className = 'meta';
        const left = document.createElement('div');
        left.innerHTML = `<div style="font-weight:700">${item.displayName||'You'}</div><div class="small">${item.text||''}</div>`;
        const right = document.createElement('div'); right.className='small'; right.textContent = timeFromTs(item.createdAt);
        meta.appendChild(left); meta.appendChild(right);
        div.appendChild(meta);

        profileSnaps.appendChild(div);
      });
    }

    // initially hide all but camera (already set) and start camera when page loads
    window.addEventListener('load', ()=>{
      startCamera();
    });

    // CLEANUP on page unload
    window.addEventListener('beforeunload', ()=>{
      stopCamera();
    });

    // NOTES (displayed as console guidance)
    console.log('SnapClone loaded. Make sure Google Sign-In is enabled in Firebase Console.');
    console.log('Suggested Firestore rules (allow create only if auth.uid matches):\n' +
      "rules_version = '2';\nservice cloud.firestore {\n  match /databases/{database}/documents {\n    match /snaps/{snapId} {\n      allow read: if true;\n      allow create: if request.auth != null && request.resource.data.uid == request.auth.uid;\n      allow delete, update: if false;\n    }\n  }\n}\n\n" +
      'Suggested Storage rules:\n' +
      "rules_version = '2';\nservice firebase.storage {\n  match /b/{bucket}/o {\n    match /snaps/{userId}/{allPaths=**} {\n      allow read: if true;\n      allow write: if request.auth != null && request.auth.uid == userId;\n    }\n  }\n}\n"
    );

  </script>
</body>
</html>
